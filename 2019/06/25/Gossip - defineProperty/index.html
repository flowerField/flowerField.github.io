<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Gossip - defineProperty · 花田半亩</title><meta name="description" content="Gossip - defineProperty - 文顶顶"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/logo.jpeg"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://weibo.com/u/3800117445/atom.xml" title="花田半亩"><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="花田半亩" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/%E9%B2%B8%E9%B1%BC.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">文顶顶</a></li><li class="nav-list-item"><a href="/tags/" target="_self" class="nav-list-link">标签</a></li><li class="nav-list-item"><a href="https://www.cnblogs.com/wendingding/" target="_blank" class="nav-list-link">博客园</a></li><li class="nav-list-item"><a href="https://github.com/flowerField" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Gossip - defineProperty</h1><div class="post-info">Jun 25, 2019<span class="post-count"></span> ✧ 字数统计:1.4k(字) &nbsp;&nbsp; ♨︎ 阅读时长:6(分钟)</div><div class="post-content"><div class='tip'>本文介绍`Object.defineProperty()`方法，并基于此简单讨论数据劫持的实现方案。</div>

<h3 id="defineProperty"><a href="#defineProperty" class="headerlink" title="defineProperty"></a>defineProperty</h3><p><code>Object.getOwnPropertyDescriptor(target,attrName)</code>方法用于获取对象的属性描述符对象，该方法的第一个参数为目标对象，第二个参数为指定的属性名。</p>
<p>我们可以利用该方法来查看对象属性的描述符配置项(包括：<code>value值</code>、<code>writable可重写</code>、<code>enumerable可枚举</code>和<code>configurable可配置</code>等)。默认正常的对象属性中，这些配置项的值都是 <code>true</code>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> o = &#123; <span class="attr">name</span>: <span class="string">&quot;文顶顶&quot;</span>, <span class="attr">age</span>: <span class="number">18</span> &#125;;</span><br><span class="line"><span class="keyword">var</span> des = <span class="built_in">Object</span>.getOwnPropertyDescriptor(o, <span class="string">&quot;name&quot;</span>);</span><br><span class="line"><span class="built_in">console</span>.log(des);</span><br><span class="line"><span class="comment">/* &#123; value: &#x27;文顶顶&#x27;,writable: true,enumerable: true,configurable: true &#125; */</span></span><br></pre></td></tr></table></figure>

<p><code>Object.defineProperty(target,attrName,options)</code>方法用于定义(设置)对象并对指定的属性描述符对象进行配置。该方法的第一个参数为目标对象，第二个参数为指定的属性名，第三个参数为配置对象。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 备注：给o对象添加address属性，并设置属性值为香悦山 */</span></span><br><span class="line"><span class="comment">/* 说明：默认新添加的属性，属性描述配置项均为false */</span></span><br><span class="line"><span class="keyword">var</span> o = &#123; <span class="attr">name</span>: <span class="string">&quot;文顶顶&quot;</span>, <span class="attr">age</span>: <span class="number">18</span> &#125;;</span><br><span class="line"><span class="built_in">Object</span>.defineProperty(o, <span class="string">&quot;address&quot;</span>, &#123; <span class="attr">value</span>: <span class="string">&quot;香悦山&quot;</span> &#125;);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Object</span>.getOwnPropertyDescriptor(o, <span class="string">&quot;address&quot;</span>));</span><br><span class="line"><span class="comment">/* &#123; value: &#x27;香悦山&#x27;,writable: false,enumerable: false,configurable: false &#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 备注：重新定义age属性，设置属性值为20，该属性值可配置但无法重写和枚举 */</span></span><br><span class="line"><span class="built_in">Object</span>.defineProperty(o, <span class="string">&quot;age&quot;</span>, &#123; <span class="attr">value</span>: <span class="number">20</span>, <span class="attr">enumerable</span>: <span class="literal">false</span>, <span class="attr">writable</span>: <span class="literal">false</span> &#125;);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Object</span>.getOwnPropertyDescriptor(o, <span class="string">&quot;age&quot;</span>));</span><br><span class="line"><span class="comment">/* &#123; value: 20,writable: false,enumerable: false,configurable: true &#125; */</span></span><br><span class="line">o.age = <span class="number">99</span>;</span><br><span class="line"><span class="built_in">console</span>.log(o.age); <span class="comment">//20</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> o) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(key, o[key]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* name 文顶顶 */</span></span><br><span class="line"><span class="comment">/* 在for...in循环中，age键值对 ，以及新添加的address键值对均没有被枚举 */</span></span><br></pre></td></tr></table></figure>

<p><code>Object.defineProperties(target,options)</code>方法用于一次性设置(<code>添加</code>)对象的多个属性，与之对应的<code>Object.getOwnPropertyDescriptors(target)</code>方法用于获取对象中所有成员的 <strong>详细</strong> 配置信息。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Object</span>.defineProperties(o, &#123;</span><br><span class="line">    <span class="string">&quot;className&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">value</span>: <span class="string">&quot;H5&quot;</span>,</span><br><span class="line">        <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;friends&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">value</span>: [<span class="string">&quot;胡适&quot;</span>, <span class="string">&quot;沈从文&quot;</span>, <span class="string">&quot;辜鸿铭&quot;</span>],</span><br><span class="line">        <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">writable</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;_____&quot;</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Object</span>.getOwnPropertyDescriptors(o));</span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">&#123;   name:&#123; value: &#x27;文顶顶&#x27;, writable: true,enumerable: true,configurable: true &#125;,</span></span><br><span class="line"><span class="comment">    age:&#123; value: 20,writable: false,enumerable: false,configurable: true &#125;,</span></span><br><span class="line"><span class="comment">    address:&#123; value: &#x27;香悦山&#x27;,writable: false,enumerable: false,configurable: false &#125;,</span></span><br><span class="line"><span class="comment">    className:&#123; value: &#x27;H5&#x27;,writable: false,enumerable: false,configurable: true &#125;,</span></span><br><span class="line"><span class="comment">    friends:&#123; value: [ &#x27;胡适&#x27;, &#x27;沈从文&#x27;, &#x27;辜鸿铭&#x27; ],</span></span><br><span class="line"><span class="comment">              writable: true, enumerable: false,configurable: true &#125; &#125; */</span></span><br></pre></td></tr></table></figure>

<div class='tip'>[Object.defineProperty ]()方法主要用于对象中的某个属性进行访问配置，如果需要对整个对象执行类似的操作则可使用`Object.preventExtensions()`、`Object.seal()`和`Object.freeze()` 等方法，它们分别对应着`禁止扩展`、`密封对象`以及要`冻结`对象。</div>

<h3 id="Getter-and-Setter"><a href="#Getter-and-Setter" class="headerlink" title="Getter and Setter"></a>Getter and Setter</h3><p>对于对象字面量创建的对象而言，我们可以直接通过<code>get attrName</code>或<code>set attrName</code>的方式来对属性的设置和读取操作进行拦截和监听。通过下面的代码，我们可以观察到，对象属性的 Getter 和 Setter 的代码并不复杂但却需要借助一个无关的中间变量<code>_age</code>来实现。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* getter 和 setter */</span></span><br><span class="line"><span class="keyword">var</span> o = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;文顶顶&quot;</span>,</span><br><span class="line">    <span class="attr">_age</span>: <span class="number">17</span>,</span><br><span class="line">    <span class="keyword">get</span> <span class="title">age</span>() &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;监听到执行了getter方法&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>._age;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">set</span> <span class="title">age</span>(<span class="params">val</span>) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;监听到执行了setter方法&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>._age = val;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(o.age);</span><br><span class="line">o.age = <span class="number">100</span>;</span><br><span class="line"><span class="built_in">console</span>.log(o.age);</span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">监听到执行了getter方法</span></span><br><span class="line"><span class="comment">17</span></span><br><span class="line"><span class="comment">监听到执行了setter方法</span></span><br><span class="line"><span class="comment">监听到执行了getter方法</span></span><br><span class="line"><span class="comment">100 </span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p><code>Object.defineProperty()</code>方法的配置对象中也支持对象属性的 <code>Getter</code> 和 <code>Setter</code>操作。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> o = &#123; <span class="attr">name</span>: <span class="string">&quot;文顶顶&quot;</span>, <span class="attr">age</span>: <span class="number">17</span> &#125;;</span><br><span class="line">    <span class="keyword">var</span> temp = <span class="number">18</span>;</span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(o, <span class="string">&quot;age&quot;</span>, &#123;</span><br><span class="line">        <span class="function"><span class="title">get</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;——getter———&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> temp;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="function"><span class="title">set</span>(<span class="params">val</span>)</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;——setter———&quot;</span>);</span><br><span class="line">            temp = val;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">console</span>.log(o.age);</span><br><span class="line">    o.age = <span class="number">100</span>;</span><br><span class="line">    <span class="built_in">console</span>.log(o.age);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 执行情况 */</span></span><br><span class="line">    <span class="comment">// ——getter———</span></span><br><span class="line">    <span class="comment">// 18</span></span><br><span class="line">    <span class="comment">// ——setter———</span></span><br><span class="line">    <span class="comment">// ——getter———</span></span><br><span class="line">    <span class="comment">// 100</span></span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<hr>
利用`Object.defineProperty()`方法，来监听对象属性的设置和读取操作，可以不必借助于中间属性来实现而改用一个外部变量即可，这样的处理方式为代码的封装提供了可能。

<p><strong>注意</strong> 在 <code>defineProperty</code> 方法内部使用 <code>set 和 get</code> 函数时不能与 <code>value 和 writable</code> 共存。上述的代码演示了监听对象单个属性读写的方案，如果需要为对象中所有的属性都添加 <code>set 和 get</code> 监听，可以考虑对上述代码进行封装。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> observer = <span class="function">(<span class="params">target</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> target !== <span class="string">&quot;object&quot;</span> || target == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> target) &#123;</span><br><span class="line">        <span class="keyword">if</span> (target.hasOwnProperty(key)) defineReactive(target, key, target[key]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> defineReactive = <span class="function">(<span class="params">target, key, val</span>) =&gt;</span> &#123;</span><br><span class="line">    observer(val); <span class="comment">/* 递归解决多层对象解构问题 */</span></span><br><span class="line">    <span class="comment">/* val 是外部传入的参数：就是指定属性的默认值 */</span></span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(target, key, &#123;</span><br><span class="line">        <span class="function"><span class="title">get</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">            handler(<span class="string">&quot;getter&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> val;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="function"><span class="title">set</span>(<span class="params">_val</span>)</span> &#123;</span><br><span class="line">            handler(<span class="string">&quot;setter&quot;</span>)</span><br><span class="line">            val = _val;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> handler = <span class="function">(<span class="params">text</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;监听到&quot;</span> + text);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 测试代码 */</span></span><br><span class="line"><span class="keyword">var</span> o = &#123; <span class="attr">name</span>: <span class="string">&quot;文顶顶&quot;</span>, <span class="attr">age</span>: <span class="number">18</span>, <span class="attr">car</span>: &#123; <span class="attr">color</span>: <span class="string">&quot;white&quot;</span> &#125; &#125;;</span><br><span class="line">observer(o);</span><br><span class="line">o.age = <span class="number">100</span>;</span><br><span class="line"><span class="built_in">console</span>.log(o.age);</span><br><span class="line">o.car.color = <span class="string">&quot;black&quot;</span>;</span><br><span class="line"><span class="built_in">console</span>.log(o.car.color);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 执行情况 */</span></span><br><span class="line"><span class="comment">// 监听到setter</span></span><br><span class="line"><span class="comment">// 监听到getter</span></span><br><span class="line"><span class="comment">// 100</span></span><br><span class="line"><span class="comment">// 监听到getter</span></span><br><span class="line"><span class="comment">// 监听到setter</span></span><br><span class="line"><span class="comment">// 监听到getter</span></span><br><span class="line"><span class="comment">// 监听到getter</span></span><br><span class="line"><span class="comment">// black</span></span><br></pre></td></tr></table></figure>

<img src='../../../../z.png' width="200px">

<ul>
<li>Posted by 博客园·<a target="_blank" rel="noopener" href="http://www.cnblogs.com/wendingding/">文顶顶</a> | <a target="_blank" rel="noopener" href="http://wendingding.com/">花田半亩</a></li>
<li>联系作者 简书·<a target="_blank" rel="noopener" href="http://www.jianshu.com/users/c5703017b9f5/latest_articleshttp://www.jianshu.com/users/c5703017b9f5/latest_articles">文顶顶</a> 新浪微博·<a href="http://weibo.com/p/1005053800117445/home?from=page_100505&mod=TAB#place">Coder_文顶顶</a></li>
<li>原创文章，版权声明：自由转载-非商用-非衍生-保持署名 | <a target="_blank" rel="noopener" href="http://www.cnblogs.com/wendingding/">文顶顶</a></li>
</ul>
</div></article></div></main><footer><div class="paginator"><a href="/2019/06/27/%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97%20Promise/" class="prev">上一篇</a><a href="/2019/06/25/Gossip%20-%20deepClone/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2022 <a href="https://weibo.com/u/3800117445">文顶顶</a> &nbsp;☁ 全站字数统计 418.8k (字)</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>