<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> javaScript系列 [15]-Canvas绘图(压缩) · 花田半亩</title><meta name="description" content="javaScript系列 [15]-Canvas绘图(压缩) - 文顶顶"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/logo.jpeg"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://weibo.com/u/3800117445/atom.xml" title="花田半亩"><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="花田半亩" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/%E9%B2%B8%E9%B1%BC.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">文顶顶</a></li><li class="nav-list-item"><a href="/tags/" target="_self" class="nav-list-link">标签</a></li><li class="nav-list-item"><a href="/tool/" target="_self" class="nav-list-link">工具</a></li><li class="nav-list-item"><a href="https://www.cnblogs.com/wendingding/" target="_blank" class="nav-list-link">博客园</a></li><li class="nav-list-item"><a href="https://github.com/flowerField" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">javaScript系列 [15]-Canvas绘图(压缩)</h1><div class="post-info">Apr 26, 2018<span class="post-count"></span> ✧ 字数统计:1.5k(字) &nbsp;&nbsp; ♨︎ 阅读时长:6(分钟)</div><div class="post-content"><p class='tip'>写这篇文章的原因是因为今天早上的时候，突然遇到个需求需要等比例调整照片的大小（主要是想把图片等比例的缩小），我在Mac上通过图片处理软件捣鼓的时候发现比较麻烦，就随手百度了一个在线修改图片尺寸的网站，叫做[改图宝](http://www.gaitubao.com/)。这个网站提供给图片加logo、修改图片尺寸以及印章制作等诸多功能，界面简洁使用方便解决了我的问题，值得推荐。

<p>然而，等到中午的时候，我发现还有一张图片需要处理，恰好电脑连不上网络，我就考虑能不能通过代码自己来实现，因为图片的**<code>选择 - 压缩 - 上传</code>**在实际开发中也是对应的场景，因此本文将介绍如何利用Canvas画布来对图片进行压缩的技术，包括实现思路和具体的代码。</p></p>
<div class='titleX'>**实现思路**</div>
<img src='../../../../src/canvas_38.png'>

<p><strong>[ 1 ] 获取源图像数据</strong></p>
<p>在页面中我们使用<code>input标签(file类型)</code>来让用户选择对应的文件上传。为了等比例的对图片进行压缩，需要获取源图片的宽度和高度等数据参数，这里使用了**<a href="">FileReader构造函数</a>**(类)。</p>
<p>具体实现的时候，先调用<code>new FileReader()</code>创建一个FileReader的实例对象，然后为<code>input标签</code>注册<span style='color:red'>change</span>事件监听。当用户选择好文件后，需要先检查是否是图片(<a target="_blank" rel="noopener" href="https://www.iana.org/assignments/media-types/media-types.xhtml">通过MIMEType类型判断</a>)，再通过FileReader实例来调用<code>readAsDataURL(file)</code>方法来读取图片文件的数据信息，以获取源图片文件的宽度和高度信息。</p>
<p><strong>[ 2 ] 计算宽高压缩比数据</strong></p>
<p>因为示例代码中演示的等比例的进行缩放(压缩)，因此需要通过得到目标图片的宽度和高度尺寸数据。<br>这里列出计算部分的**<span style='color:red'>核心代码</span>**：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> targetWidth,targetHeight;</span><br><span class="line"><span class="keyword">var</span> imgWidth = img.width, imgHeight = img.height;</span><br><span class="line"><span class="keyword">var</span> maxWidth = <span class="number">150</span>, maxHeight = <span class="number">150</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果图片尺寸超过限制，那么需要重新计算宽高</span></span><br><span class="line"><span class="keyword">if</span> (imgWidth &gt; maxWidth || imgHeight &gt; maxHeight) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (imgWidth / imgHeight &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="comment">// 如果更宽，那么就按照宽度限定尺寸</span></span><br><span class="line">    targetWidth = maxWidth;</span><br><span class="line">    targetHeight = <span class="built_in">Math</span>.round(maxWidth * (imgHeight / imgWidth));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 如果更高，那么就按照高度限定尺寸</span></span><br><span class="line">    targetHeight = maxHeight;</span><br><span class="line">    targetWidth = <span class="built_in">Math</span>.round(maxHeight * (imgWidth / imgHeight));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>[ 3 ] 绘制目标图片</strong></p>
<p>当目标图片(压缩后)的宽高都计算完成后，可以通过Canvas上下文的<code>drawImage</code>方法来完成图片的绘制，该方法的具体使用可以参考<a target="_blank" rel="noopener" href="http://wendingding.com/2019/02/05/javaScript%E7%B3%BB%E5%88%97%20[14]-Canvas%E7%BB%98%E5%9B%BE(%E5%9B%BE%E5%83%8F"> javaScript系列 [14]-Canvas绘图(图像)</a>这篇文章。</p>
<p><code>drawImage</code>方法的第一个参数为需要绘制的图片数据，该图片数据即为用户通过input标签选择的文件内容。当然，在具体实现的时候还需要读取文件的内容，监听加载完毕之后再设置Image数据源。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">reader.onload = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">  /e.target.result是图片的base64地址信息</span><br><span class="line">  img.src = event.target.result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class='titleX'>**完整代码**</div>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">  &lt;title&gt;Title&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;input type=&quot;file&quot; id=&quot;file&quot;&gt;</span><br><span class="line">&lt;div id=&quot;info&quot; style=&quot;font-size: 13px&quot;&gt;&lt;/div&gt;</span><br><span class="line">&lt;canvas id=&quot;canvas&quot; height=&quot;200&quot; width=&quot;200&quot;&gt;&lt;/canvas&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line"></span><br><span class="line">  //[1] 获取页面中的文件选择标签</span><br><span class="line">  var oInput  = document.querySelector(&#x27;#file&#x27;);</span><br><span class="line"></span><br><span class="line">  //[2] 创建FileReader对象用于读取文件信息</span><br><span class="line">  var reader = new FileReader();</span><br><span class="line">  var file   = null;  //文件对象</span><br><span class="line"></span><br><span class="line">  //[3] 给文件选择标签添加事件监听</span><br><span class="line">  oInput.addEventListener(&#x27;change&#x27;, function (event) &#123;</span><br><span class="line"></span><br><span class="line">    //001 获取用户选择的文件</span><br><span class="line">    file = event.target.files[0];</span><br><span class="line"></span><br><span class="line">    //002 获取文件的MIMEType类型</span><br><span class="line">    var fileType = file.type;</span><br><span class="line"></span><br><span class="line">    //003 检查用户选择的文件是否是图片</span><br><span class="line">    if (fileType.indexOf(&quot;image&quot;) == 0) &#123;</span><br><span class="line"></span><br><span class="line">      //004 如果发现文件是图片则读取图片为DataURL</span><br><span class="line">      reader.readAsDataURL(file);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  //[4] 创建Image图像实例</span><br><span class="line">  var img  = new Image();</span><br><span class="line">  var targetWidth,targetHeight;</span><br><span class="line"></span><br><span class="line">  //[5] 监听FileReader对象是否处理完毕，设置图像实例的数据源</span><br><span class="line">  reader.onload = function(event) &#123;</span><br><span class="line"></span><br><span class="line">    //说明：e.target.result是图片的base64地址信息</span><br><span class="line">    img.src = event.target.result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">    //[6] 监听Image实例加载，压缩图片并生成预览图像</span><br><span class="line">    img.onload = function () &#123;</span><br><span class="line"></span><br><span class="line">      setFileInfo();</span><br><span class="line"></span><br><span class="line">      //[7]在页面中创建canvas画布对图片进行缩放(压缩)后绘制</span><br><span class="line">      var canvas = document.getElementById(&quot;canvas&quot;);</span><br><span class="line">      var ctx = canvas.getContext(&quot;2d&quot;);</span><br><span class="line">      ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);</span><br><span class="line">      ctx.drawImage(img, 0, 0, targetWidth, targetHeight);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function setFileInfo() &#123;</span><br><span class="line">      // 获取文件的名称</span><br><span class="line">      var fileName = file.name;</span><br><span class="line"></span><br><span class="line">      // 获取文件的大小</span><br><span class="line">      var fileSize = (file.size / 1024 / 1024).toFixed(3) + &quot;M&quot;;</span><br><span class="line"></span><br><span class="line">      // 图片压缩比计算</span><br><span class="line">      var imgWidth = img.width, imgHeight = img.height;</span><br><span class="line">      var maxWidth = 150, maxHeight = 150;</span><br><span class="line"></span><br><span class="line">      // 如果图片尺寸超过限制，那么需要重新计算宽高</span><br><span class="line">      if (imgWidth &gt; maxWidth || imgHeight &gt; maxHeight) &#123;</span><br><span class="line"></span><br><span class="line">        if (imgWidth / imgHeight &gt;= 1) &#123;</span><br><span class="line">          // 如果更宽，那么就按照宽度限定尺寸</span><br><span class="line">          targetWidth = maxWidth;</span><br><span class="line">          targetHeight = Math.round(maxWidth * (imgHeight / imgWidth));</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          // 如果更高，那么就按照高度限定尺寸</span><br><span class="line">          targetHeight = maxHeight;</span><br><span class="line">          targetWidth = Math.round(maxHeight * (imgWidth / imgHeight));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //在页面中显示图片信息</span><br><span class="line">        var html = &quot;&lt;div&gt;1.已选择图片&quot; + fileName + &quot;，大小为&quot; + fileSize + &quot;。&lt;/div&gt;\n&quot; +</span><br><span class="line">            &quot;&lt;div&gt;2.图片原尺寸是：&quot; + imgWidth + &quot; x &quot; + imgHeight + &quot;&lt;/div&gt;\n&quot; +</span><br><span class="line">            &quot;&lt;div&gt;3.图片压缩尺寸：&quot; + maxWidth + &quot; x &quot; + maxHeight + &quot;&lt;/div&gt;\n&quot; +</span><br><span class="line">            &quot;&lt;div&gt;4.图片已压缩为：&quot; + targetWidth + &quot; x &quot; + targetHeight +&quot;&lt;/div&gt;\n&quot;;</span><br><span class="line"></span><br><span class="line">        var oDiv = document.getElementById(&quot;info&quot;);</span><br><span class="line">        oDiv.innerHTML = html;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<div class='titleX'>**演示效果**</div>

<img src='../../../../src/canvas_37.gif'>

<img src='../../../../z.png' width="200px">

<hr>
<ul>
<li>Posted by 博客园·<a target="_blank" rel="noopener" href="http://www.cnblogs.com/wendingding/">文顶顶</a> | <a target="_blank" rel="noopener" href="http://wendingding.com/">花田半亩</a></li>
<li>联系作者 简书·<a target="_blank" rel="noopener" href="http://www.jianshu.com/users/c5703017b9f5/latest_articleshttp://www.jianshu.com/users/c5703017b9f5/latest_articles">文顶顶</a> 新浪微博·<a href="http://weibo.com/p/1005053800117445/home?from=page_100505&mod=TAB#place">Coder_文顶顶</a></li>
<li>原创文章，版权声明：自由转载-非商用-非衍生-保持署名 | <a target="_blank" rel="noopener" href="http://www.cnblogs.com/wendingding/">文顶顶</a></li>
</ul>
</div></article></div></main><footer><div class="paginator"><a href="/2018/04/27/javaScript%E7%B3%BB%E5%88%97%20%5B16%5D-JavaScript%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80/" class="prev">上一篇</a><a href="/2018/04/25/javaScript%E7%B3%BB%E5%88%97%20%5B14%5D-Canvas%E7%BB%98%E5%9B%BE(%E5%9B%BE%E5%83%8F)/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2022 <a href="https://weibo.com/u/3800117445">文顶顶</a> &nbsp;☁ 全站字数统计 418.1k (字)</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>